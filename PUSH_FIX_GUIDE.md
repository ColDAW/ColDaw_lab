# Push åŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨æ›´æ–° .als æ–‡ä»¶å¹¶ä¿å­˜åï¼Œç‚¹å‡» Push æŒ‰é’®æ—¶å‡ºç° "Failed to push changes" é”™è¯¯ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

1. **å¤–é”®çº¦æŸå†²çª**: `versions` è¡¨æœ‰å¤–é”®çº¦æŸ `FOREIGN KEY (user_id) REFERENCES users(id)`
2. **é”™è¯¯çš„ç”¨æˆ·æ ‡è¯†**: å‰ç«¯ä¼ é€’ `user.username` è€Œä¸æ˜¯ `user.id`
3. **ç¡¬ç¼–ç çš„ç³»ç»Ÿç”¨æˆ·**: åç«¯ä½¿ç”¨ `'anonymous-system'` å’Œ `'vst-plugin-system'`ï¼Œè¿™äº›ç”¨æˆ·åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨

## âœ… ä¿®å¤å†…å®¹

### 1. åç«¯ä¿®å¤ (`server/src/routes/version.ts`)

**ä¿®æ”¹å‰**:
```typescript
user_id: 'anonymous-system'  // ç¡¬ç¼–ç å­—ç¬¦ä¸²
user_id: 'vst-plugin-system' // ç¡¬ç¼–ç å­—ç¬¦ä¸²
```

**ä¿®æ”¹å**:
```typescript
// è·å–å®é™…çš„ç”¨æˆ· ID
let userId = author || 'anonymous';
if (req.user && req.user.id) {
  userId = req.user.id;
}

// åœ¨ insertVersion ä¸­ä½¿ç”¨
user_id: userId  // ä½¿ç”¨å®é™…ç”¨æˆ· ID
```

### 2. å‰ç«¯ä¿®å¤ (`client/src/components/MenuBar.tsx`)

**ä¿®æ”¹å‰**:
```typescript
formData.append('author', user.username);  // âŒ é”™è¯¯

await versionApi.commitVersion(
  // ...
  user.username  // âŒ é”™è¯¯
);
```

**ä¿®æ”¹å**:
```typescript
formData.append('author', user.id);  // âœ… æ­£ç¡®

await versionApi.commitVersion(
  // ...
  user.id  // âœ… æ­£ç¡®
);
```

## ğŸ”„ å¦‚ä½•åº”ç”¨ä¿®å¤

### 1. é‡å¯åç«¯æœåŠ¡å™¨

```bash
cd server
npm run dev
```

### 2. é‡æ–°æ„å»ºå‰ç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
cd client
npm run dev
```

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆæ¨èï¼‰

- **Chrome**: Cmd+Shift+Delete â†’ æ¸…é™¤ç¼“å­˜
- **æˆ–**: åœ¨å¼€å‘è€…å·¥å…·ä¸­ç¡¬åˆ·æ–° (Cmd+Shift+R)

## ğŸ“‹ æµ‹è¯•æ­¥éª¤

1. **ç™»å½•åº”ç”¨**
   - è®¿é—® http://localhost:5173
   - ä½¿ç”¨æœ‰æ•ˆè´¦æˆ·ç™»å½•

2. **å¯¼å…¥æˆ–ä¸Šä¼ é¡¹ç›®**
   - ä¸Šä¼ æ–°çš„ .als æ–‡ä»¶
   - æˆ–ä» VST æ’ä»¶å¯¼å…¥

3. **ç‚¹å‡» Push æŒ‰é’®**
   - è¾“å…¥æäº¤ä¿¡æ¯
   - ç‚¹å‡»ç¡®è®¤

4. **éªŒè¯æˆåŠŸ**
   - åº”è¯¥çœ‹åˆ° "Changes pushed successfully!" æ¶ˆæ¯
   - æ£€æŸ¥ç‰ˆæœ¬å†å²ä¸­æ˜¯å¦å‡ºç°æ–°ç‰ˆæœ¬

## ğŸ¯ é¢„æœŸè¡Œä¸º

### Push æˆåŠŸå:
- âœ… æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
- âœ… æ¸…é™¤å¾…å¤„ç†çš„æ›´æ”¹
- âœ… ç‰ˆæœ¬å†å²æ›´æ–°
- âœ… é¡¹ç›®åˆ—è¡¨æ›´æ–°æ—¶é—´æˆ³

### æ•°æ®åº“ä¸­:
- âœ… `versions` è¡¨æ’å…¥æ–°è®°å½•
- âœ… `user_id` ä¸ºæœ‰æ•ˆçš„ç”¨æˆ· ID
- âœ… å¤–é”®çº¦æŸæ»¡è¶³

## ğŸ” ç”¨æˆ· ID å¤„ç†é€»è¾‘

```typescript
// ä¼˜å…ˆçº§é¡ºåº:
1. req.user.id (æ¥è‡ªè®¤è¯ token)
2. author å‚æ•° (å‰ç«¯ä¼ é€’çš„ user.id)
3. 'anonymous' (ä½œä¸ºåå¤‡)
```

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®å¤çš„åŠŸèƒ½:
- âœ… Web åº”ç”¨ä¸­çš„ Push æŒ‰é’®
- âœ… VST æ’ä»¶å¯¼å…¥åçš„ Push
- âœ… æ™®é€šæ–‡ä»¶ä¸Šä¼ åçš„ Push

### ä¸å—å½±å“çš„åŠŸèƒ½:
- âœ… é¡¹ç›®åˆ›å»º
- âœ… ç‰ˆæœ¬æµè§ˆ
- âœ… åˆ†æ”¯æ“ä½œ
- âœ… ä¸‹è½½åŠŸèƒ½

## ğŸ› å¦‚æœä»ç„¶å¤±è´¥

### æ£€æŸ¥æ§åˆ¶å°é”™è¯¯

**å‰ç«¯ (æµè§ˆå™¨æ§åˆ¶å°)**:
```
F12 â†’ Console æ ‡ç­¾
æŸ¥æ‰¾çº¢è‰²é”™è¯¯æ¶ˆæ¯
```

**åç«¯ (æœåŠ¡å™¨ç»ˆç«¯)**:
```
æŸ¥çœ‹ç»ˆç«¯è¾“å‡º
å¯»æ‰¾ "Error committing version" æ¶ˆæ¯
```

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

#### é”™è¯¯ 1: "user_id violates foreign key constraint"
```
åŸå› : ç”¨æˆ· ID ä¸å­˜åœ¨äº users è¡¨
è§£å†³: ç¡®ä¿å·²ç™»å½•ï¼Œä½¿ç”¨æœ‰æ•ˆè´¦æˆ·
```

#### é”™è¯¯ 2: "Temp file not found"
```
åŸå› : VST å¯¼å…¥çš„ä¸´æ—¶æ–‡ä»¶å·²è¢«æ¸…ç†
è§£å†³: é‡æ–°ä» VST æ’ä»¶å¯¼å…¥
```

#### é”™è¯¯ 3: "Branch not found"
```
åŸå› : æŒ‡å®šçš„åˆ†æ”¯ä¸å­˜åœ¨
è§£å†³: æ£€æŸ¥å½“å‰åˆ†æ”¯ï¼Œæˆ–åˆ›å»ºæ–°åˆ†æ”¯
```

#### é”™è¯¯ 4: "No file uploaded"
```
åŸå› : æ–‡ä»¶ä¸Šä¼ å¤±è´¥æˆ–ä¸ºç©º
è§£å†³: é‡æ–°é€‰æ‹©å¹¶ä¸Šä¼ æ–‡ä»¶
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `server/src/routes/version.ts` | ä¿®å¤ç”¨æˆ· ID å¤„ç†é€»è¾‘ |
| `client/src/components/MenuBar.tsx` | ä¼ é€’æ­£ç¡®çš„ç”¨æˆ· ID |

## âœ¨ ä¿®å¤å®Œæˆ

ä¿®å¤åï¼ŒPush åŠŸèƒ½åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼š
- âœ… ä½¿ç”¨å®é™…ç™»å½•ç”¨æˆ·çš„ ID
- âœ… æ»¡è¶³æ•°æ®åº“å¤–é”®çº¦æŸ
- âœ… æ­£ç¡®ä¿å­˜ç‰ˆæœ¬å†å²
- âœ… æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯

---

**ä¿®å¤æ—¥æœŸ**: 2025å¹´10æœˆ7æ—¥  
**å½±å“ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… å·²ä¿®å¤
