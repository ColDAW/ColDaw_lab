# Mailgun vs Zoho 对比表\n\n## 配置对比\n\n| 方面 | Mailgun | Zoho |\n|-----|--------|------|\n| **API 认证** | Basic Auth (base64) | OAuth 2.0 Token |\n| **核心凭证** | API Key + Domain | API Key + Account ID |\n| **区域支持** | US/EU 选择 | 全球统一 |\n| **API 端点** | `https://api.mailgun.net/v3/{domain}/messages` | `https://mail.zoho.com/api/accounts/{id}/messages` |\n| **请求格式** | Form Data | JSON |\n| **认证头** | `Authorization: Basic base64(api:key)` | `Authorization: Zoho-oauthtoken token` |\n\n## 环境变量对比\n\n### Mailgun\n```bash\nMAILGUN_API_KEY=key-xxx\nMAILGUN_DOMAIN=mail.yourdomain.com\nMAILGUN_REGION=us|eu\nFROM_EMAIL=sender@yourdomain.com\n```\n\n### Zoho\n```bash\nZOHO_API_KEY=token_xxx\nZOHO_ACCOUNT_ID=account_id\nZOHO_FROM_EMAIL=noreply@yourdomain.com  # 可选\n```\n\n## 代码对比\n\n### 配置接口\n```typescript\n// Mailgun\nexport interface MailgunConfig {\n  apiKey: string;\n  domain: string;\n  region?: 'us' | 'eu';\n}\n\n// Zoho\nexport interface ZohoConfig {\n  apiKey: string;\n  accountId: string;\n}\n```\n\n### 初始化检查\n```typescript\n// Mailgun\nif (mailgunApiKey && mailgunDomain) {\n  this.useMailgunAPI = true;\n  // ...\n}\n\n// Zoho\nif (zohoApiKey && zohoAccountId) {\n  this.useZohoAPI = true;\n  // ...\n}\n```\n\n### API 调用方式\n\n**Mailgun (Form Data):**\n```typescript\nconst formData = new FormData();\nformData.append('from', email);\nformData.append('to', recipient);\nformData.append('html', html);\n\nconst response = await fetch(url, {\n  method: 'POST',\n  headers: {\n    'Authorization': `Basic ${base64('api:' + key)}`\n  },\n  body: formData\n});\n```\n\n**Zoho (JSON):**\n```typescript\nconst payload = {\n  fromAddress: email,\n  toAddress: recipient,\n  htmlBody: html\n};\n\nconst response = await fetch(url, {\n  method: 'POST',\n  headers: {\n    'Authorization': `Zoho-oauthtoken ${token}`,\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify(payload)\n});\n```\n\n## 功能特性对比\n\n| 功能 | Mailgun | Zoho | 优先级 |\n|-----|--------|------|--------|\n| 发送验证邮件 | ✅ | ✅ | P0 |\n| HTML 模板 | ✅ | ✅ | P0 |\n| 纯文本邮件 | ✅ | ✅ | P0 |\n| 邮件追踪 | ✅ | ✅ | P2 |\n| 自定义 Headers | ✅ | ✅ | P2 |\n| 附件支持 | ✅ | ✅ | P3 |\n| 模板引擎 | ✅ | ✅ | P3 |\n| Webhook | ✅ | ✅ | P3 |\n\n## 迁移影响\n\n### 受影响的文件\n- ✅ `/server/src/services/email.ts` - 主要实现\n- ✅ `/server/src/routes/auth.ts` - 使用该服务\n- ✅ 环境配置文件\n\n### 不受影响的文件\n- `/server/src/services/redis.ts` - 验证码存储\n- `/server/src/database/` - 数据库操作\n- `/client/` - 客户端代码\n- 其他 API 路由\n\n## 向后兼容性\n\n✅ **完全支持**：新代码支持以下回退链\n\n1. **Zoho API** (优先) - `ZOHO_API_KEY` + `ZOHO_ACCOUNT_ID`\n2. **SMTP** (备用) - `SMTP_HOST` + `SMTP_USER` + `SMTP_PASS`\n3. **Mailgun API** (兼容) - `MAILGUN_API_KEY` + `MAILGUN_DOMAIN`\n4. **失败** - 返回错误\n\n## 性能对比\n\n| 指标 | Mailgun | Zoho | 备注 |\n|-----|--------|------|------|\n| API 响应时间 | ~200ms | ~200ms | 相当 |\n| 认证开销 | 低 (Base64) | 中 (Token) | 可忽略 |\n| 连接池支持 | ✅ | ✅ | 都支持 |\n| 重试机制 | ✅ | ✅ | 都支持 |\n| 速率限制 | 有 | 有 | 都有 |\n\n## 成本对比\n\n| 方面 | Mailgun | Zoho |\n|-----|--------|------|\n| 验证邮件限额 | 一般 10K/月 | 基于订阅 |\n| 自定义域名 | ✅ | ✅ |\n| 企业支持 | ✅ (付费) | ✅ (付费) |\n\n## 切换步骤\n\n```bash\n# 1. 配置 Zoho\nexport ZOHO_API_KEY=\"token\"\nexport ZOHO_ACCOUNT_ID=\"id\"\nexport ZOHO_FROM_EMAIL=\"sender@domain\"\n\n# 2. 可选保留 SMTP 备用\nexport SMTP_HOST=\"smtp.zoho.com\"\nexport SMTP_PORT=\"587\"\nexport SMTP_USER=\"email@domain\"\nexport SMTP_PASS=\"password\"\n\n# 3. 启动应用\nnpm run dev\n\n# 4. 验证日志\n# 应显示: ✅ Email service initialized with Zoho Mail API\n\n# 5. 测试邮件发送\n# 完成！\n```\n\n## 故障诊断\n\n**问题**: 日志显示 SMTP 而非 Zoho\n**原因**: 环境变量未正确设置\n**解决**: 检查 `ZOHO_API_KEY` 和 `ZOHO_ACCOUNT_ID`\n\n**问题**: 401 Unauthorized\n**原因**: Token 无效或过期\n**解决**: 重新生成 OAuth Token\n\n**问题**: 403 Forbidden\n**原因**: 权限不足\n**解决**: 添加 `Zoho.mail.messages.CREATE` scope\n\n**问题**: 邮件被标记为垃圾\n**原因**: 发送人地址未验证\n**解决**: 在 Zoho 中验证 `ZOHO_FROM_EMAIL`\n\n---\n\n**总结**: ✅ Zoho 提供了与 Mailgun 相同的功能，且配置更简洁，OAuth 安全性更高。\n"